{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "data": { "url": "section1_datasource.csv" },

  "transform": [
    {
      "calculate": "isDate(datum.Date) ? toDate(datum.Date) : toDate(datum.Date_Year + '-' + (datum.Date_Month || 1) + '-' + (datum.Date_Day || 1))",
      "as": "date"
    },
    { "calculate": "toNumber(datum.Percent_Bleaching)", "as": "pct_bleach" },
    { "filter": "year(datum.date) >= 2005" }
  ],

  "vconcat": [
    {
      "hconcat": [
        {
          "width": 450,
          "height": 300,
          "projection": { "type": "equalEarth", "rotate": [-150, 0, 0] },
          "layer": [
            {
              "data": {
                "url": "https://raw.githubusercontent.com/FIT3179/Vega-Lite/main/2_symbol_map/js/ne_110m_admin_0_countries.topojson",
                "format": { "type": "topojson", "feature": "ne_110m_admin_0_countries" }
              },
              "mark": { "type": "geoshape", "fill": "lightgray", "stroke": "white" }
            },
            {
              "data": {
                "url": "https://raw.githubusercontent.com/FIT3179/Vega-Lite/main/7_others/oceans.topojson",
                "format": { "type": "topojson", "feature": "oceans" }
              },
              "mark": { "type": "geoshape", "fill": "skyblue" }
            },
            {
              "data": {
                "url": "https://raw.githubusercontent.com/FIT3179/Vega-Lite/main/2_symbol_map/js/WorldMapWithGraticules.topojson",
                "format": { "type": "topojson", "feature": "ne_110m_graticules_30" }
              },
              "mark": { "type": "geoshape", "fill": null, "stroke": "lightgray" }
            },
            {
              "transform": [{ "filter": { "param": "time_brush" } }],
              "encoding": {
                "longitude": { "field": "Longitude_Degrees", "type": "quantitative" },
                "latitude": { "field": "Latitude_Degrees", "type": "quantitative" },
                "color": {
                  "field": "pct_bleach",
                  "type": "quantitative",
                  "title": "% Bleaching",
                  "scale": {
                    "type": "threshold",
                    "domain": [1, 20, 50, 80],
                    "range": ["#f3e79b", "#f8a07e", "#ce6693", "#a059a0", "#5c53a5"]
                  },
                  "legend": { "title": "% Bleaching", "orient": "right", "offset": 0 }
                },
                "tooltip": [
                  { "field": "date", "type": "temporal", "title": "Date" },
                  { "field": "Site_Name", "type": "nominal", "title": "Site" },
                  { "field": "Country_Name", "type": "nominal", "title": "Country" },
                  { "field": "pct_bleach", "type": "quantitative", "title": "% Bleaching" }
                ]
              },
              "layer": [
                { "mark": { "type": "circle", "opacity": 0.7, "size": 18 } },
                {
                  "transform": [
                    { "window": [{ "op": "row_number", "as": "rn" }], "sort": [{ "field": "pct_bleach", "order": "descending" }] },
                    { "filter": "datum.rn == 1" },
                    { "calculate": "'Worst bleaching: ' + format(datum.pct_bleach,'~r') + '%'", "as": "label" }
                  ],
                  "layer": [
                    {
                      "mark": {
                        "type": "point",
                        "size": 220,
                        "shape": "M0,.5L.6,.8L.5,.1L1,-.3L.3,-.4L0,-1L-.3,-.4L-1,-.3L-.5,.1L-.6,.8L0,.5Z"
                      },
                      "encoding": {
                        "longitude": { "field": "Longitude_Degrees", "type": "quantitative" },
                        "latitude": { "field": "Latitude_Degrees", "type": "quantitative" },
                        "color": { "field": "pct_bleach", "type": "quantitative", "legend": null }
                      }
                    },
                    {
                      "mark": { "type": "text", "align": "center", "dx": 5, "dy": -6, "fontStyle": "italic", "stroke": "black", "strokeWidth": 0.8 },
                      "encoding": {
                        "longitude": { "field": "Longitude_Degrees" },
                        "latitude": { "field": "Latitude_Degrees" },
                        "text": { "field": "label" }
                      }
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "width": 200,
          "height": 250,
          "mark": "area",
          "encoding": {
            "x": {
              "field": "date",
              "timeUnit": "yearmonth",
              "scale": { "domain": { "param": "time_brush" } },
              "axis": { "title": "", "tickCount": 5, "grid": false }
            },
            "y": { "aggregate": "count", "title": "Count of Sites" },
            "color": {
              "field": "pct_bleach",
              "type": "quantitative",
              "title": "% Bleaching",
              "scale": {
                "type": "threshold",
                "domain": [1, 20, 50, 80],
                "range": ["#f3e79b", "#f8a07e", "#ce6693", "#a059a0", "#5c53a5"]
              },
              "legend": null
            }
          }
        }
      ],
      "spacing": 10
    },
    {
      "width": 710,
      "height": 100,
      "mark": { "type": "line", "color": "#f8a07e" },
      "title": "Use this line chart to filter the data by time (may take 3 seconds)",
      "params": [{ "name": "time_brush", "select": { "type": "interval", "encodings": ["x"] } }],
      "encoding": {
        "x": { "field": "date", "timeUnit": "yearmonth", "axis": { "title": "", "format": "%Y" } },
        "y": { "aggregate": "count", "axis": { "tickCount": 3, "grid": false }, "title": "Count of Sites" }
      }
    }






  ],

  
  "config": {
    "title": { "font": "Markazi Text", "fontSize": 18 },
    "concat": { "spacing": 12 }
  }
}
