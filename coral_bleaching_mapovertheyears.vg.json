{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "width": 900,
  "height": 520,
  "title": "Percentage Coral Bleaching at Reef Monitoring Sites Globally",
  "projection": {"type": "equalEarth"},


        "params": [
        {
          "name": "Year_slider",
          "value": 2016, 
          "bind": {
            "input": "range",
            "min": 1991,
            "max": 2020,
            "step": 1,
            "name": "Choosen Year: "
          }
        }
      ],

  "layer": [
    {
      "data": {
        "url": "ne_110m.json",
        "format": {"type": "topojson", "feature": "ne_110m_admin_0_countries"}
      },
      "mark": {"type": "geoshape", "fill": "lightgray", "stroke": "#979ea7"}
      
    },
    {
      "data": {
        "url": "https://raw.githubusercontent.com/FIT3179/Vega-Lite/main/7_others/oceans.topojson",
        "format": {"type": "topojson", "feature": "oceans"}
      },
      "mark": {"type": "geoshape", "fill": "#95bee9"}
    },
    {
      "data": {
        "url": "https://raw.githubusercontent.com/FIT3179/Vega-Lite/main/2_symbol_map/js/WorldMapWithGraticules.topojson",
        "format": {"type": "topojson", "feature": "ne_110m_graticules_30"}
      },
      "mark": {"type": "geoshape", "fill": null, "stroke": "#d2dce7"}
    },

    {
      "data": {"url":"global_bleaching_environmental.csv"},


      "transform": [
        {"filter": "isValid(datum.Percent_Bleaching) && datum.Percent_Bleaching != null"},
        {"filter": "datum.Date_Year == Year_slider"}
      ],


      "mark": {"type": "circle", "opacity": 0.7, "stroke": "white", "strokeWidth": 0.1},
      "encoding": {
        "longitude": {"field": "Longitude_Degrees", "type": "quantitative"},
        "latitude": {"field": "Latitude_Degrees", "type": "quantitative"},
        "size": {"value": 60},
        "color": {
          "field": "Percent_Bleaching",
          "type": "quantitative",
          "title": "Coral Cover Bleached (%)",
          "scale": {"domain":  [0, 100], "scheme": "yelloworangered", "clamp": true},
          "legend": {"format": ".0f"}
        },
        "tooltip": [
          {"field": "Site_ID", "title": "Site ID"},
          {"field": "Site_Name", "title": "Site Name"},
          {"field": "Country_Name", "title": "Country Name"},
          {"field": "Percent_Bleaching", "type": "quantitative", "format": ".1f", "title": "Coral Cover Bleached (%)"},
          {"field": "Temperature_Mean", "type": "quantitative", "format": ".1f", "title": "Temperature (mean)"},
          {"field": "Date_Year", "type": "quantitative", "title": "Year"}
        ]
      }
    },

    {
    "data": {
      "values": [
        {
          "year": 1991,
          "label": "1991: Very few reef surveys as there were limited global monitoring programs."
        },
        {
          "year": 1998,
          "label": "1998: Strong El Ni√±o caused first global bleaching so big increase in research."
        },
        {
          "year": 2016,
          "label": "2016: Major global bleaching event (2014-2017) so there were many severe cases."
        },
        {
          "year": 2020,
          "label": "2020: COVID-19 disrupted fieldwork so fewer research sites surveyed."
        }
      ]
    },
    "transform": [
      {"filter": "Year_slider == datum.year" }
    ],
    "mark": {
      "type": "text",
      "fontSize": 12,
      "fontWeight": "bold",
      "align": "left",
      "baseline": "line-bottom"
    },
    "encoding": {
      "x": {"value": 20},
      "y": {"value": 20},
      "text": {"field": "label"}
    }
    
  },

  {
  "data": {"url": "global_bleaching_environmental.csv"},
  "transform": [
    {"calculate": "toNumber(datum.Date_Year)", "as": "YearNum"},
    {"filter": "datum.YearNum == Year_slider"},

    {"calculate": "toNumber(datum.Percent_Bleaching)", "as": "BleachNum"},
    {"filter": "isFinite(datum.BleachNum)"},
    {"calculate": "toNumber(datum.Longitude_Degrees)", "as": "LonNum"},
    {"calculate": "toNumber(datum.Latitude_Degrees)",  "as": "LatNum"},
    {"filter": "isFinite(datum.LonNum) && isFinite(datum.LatNum)"},

    {"joinaggregate": [{"op": "max", "field": "BleachNum", "as": "MaxBleach"}]},
    {"filter": "datum.BleachNum == datum.MaxBleach"},

    {"window": [{"op": "row_number", "as": "i"}], "sort": [{"field": "Site_Name", "order": "ascending"}]},
    {"filter": "datum.i == 1"},

    {"calculate": "datum.Country_Name + ': ' + format(datum.BleachNum, '.0f') + '%'", "as": "Anno"}
  ],
  "mark": {"type": "text", "fontSize": 12, "align": "left", "dx": 6, "dy": -6},
  "encoding": {
    "longitude": {"field": "LonNum"},
    "latitude":  {"field": "LatNum"},
    "text":      {"field": "Anno"}
  }
  }





  ]
}
